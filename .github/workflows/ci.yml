name: CI Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Create mock PyAudio
      run: |
        mkdir -p /tmp/mock_pyaudio
        cat > /tmp/mock_pyaudio/setup.py << 'EOF'
        from setuptools import setup, find_packages
        setup(
            name="pyaudio",
            version="0.0.0",
            packages=find_packages(),
        )
        EOF
        cat > /tmp/mock_pyaudio/pyaudio/__init__.py << 'EOF'
        """
        Mock PyAudio for CI testing.
        """
        import sys
        
        class MockStream:
            def __init__(self, *args, **kwargs):
                pass
            
            def read(self, num_frames, exception_on_overflow=True):
                # Return silent audio
                return b"\x00" * num_frames * 2
            
            def stop_stream(self):
                pass
            
            def close(self):
                pass
            
            def is_active(self):
                return False
        
        class PyAudio:
            def __init__(self):
                self._devices = [
                    {"index": 0, "name": "Mock Device", "maxInputChannels": 1, 
                     "defaultSampleRate": 16000, "maxOutputChannels": 0},
                ]
            
            def get_device_count(self):
                return 1
            
            def get_device_info_by_index(self, idx):
                import copy
                device = copy.deepcopy(self._devices[0])
                device["index"] = idx
                return device
            
            def get_default_input_device_info(self):
                return self._devices[0]
            
            def open(self, format=8, channels=1, rate=16000, input=True, 
                    output=False, frames_per_buffer=1024, input_device_index=None, 
                    output_device_index=None, stream_callback=None, start=True):
                return MockStream()
            
            def terminate(self):
                pass
            
            def get_sample_size(self, format):
                return 2
        
        # Module-level constants
        paInt16 = 8
        paContinue = 0
        paComplete = 1
        paAbort = 2
        EOF
        
        pip install /tmp/mock_pyaudio

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        # Skip real pyaudio installation
        if [ -f requirements.txt ]; then
          grep -v "pyaudio" requirements.txt > requirements_no_pyaudio.txt || true
          pip install -r requirements_no_pyaudio.txt
        fi

    - name: Install project
      run: python -m pip install -e . --no-deps

    - name: Install test deps
      run: pip install pytest numpy pyttsx3

    - name: Run pytest
      run: pytest -v
