name: CI Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install system dependencies (optional, for faster builds)
      run: |
        sudo apt-get update
        # Install some common build dependencies
        sudo apt-get install -y build-essential python3-dev

    - name: Install Python dependencies (skip pyaudio)
      run: |
        pip install --upgrade pip
        
        # Create a filtered requirements file without pyaudio
        if [ -f requirements.txt ]; then
          echo "Filtering out pyaudio from requirements.txt..."
          # Use grep to remove pyaudio line
          grep -v "pyaudio" requirements.txt > requirements-ci.txt
          echo "Installing filtered requirements..."
          pip install -r requirements-ci.txt
        else
          echo "No requirements.txt found"
          pip install fastapi uvicorn pydantic pydantic-settings \
            torch openai-whisper numpy python-multipart \
            gradio requests huggingface-hub llama-cpp-python \
            psutil pyttsx3 pytest pytest-asyncio
        fi

    - name: Install project in development mode
      run: |
        python -m pip install -e .

    - name: Run tests
      run: |
        # Run all tests
        pytest tests/ -v
        
    # Optional: Run specific test suites
    - name: Run audio tests
      run: |
        pytest tests/audio/ -v
        
    - name: Run backend tests  
      run: |
        pytest tests/backend/ -v
